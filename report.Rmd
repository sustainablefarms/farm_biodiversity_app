---
title: "Species Predictions"
params:
  loadexampledata: TRUE
output: 
  pdf_document: 
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    extra_dependencies: "booktabs"
header-includes:
  \renewcommand{\href}[2]{#2\footnote{\url{#1}}}
---

```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
```

```{r load, echo = FALSE, include = FALSE}
if (params$loadexampledata){
  pkgload::load_all(".")
  main_app_prep()
  current_values <- readRDS("tests/testthat/current_values_2patches.rds")
  data <- readRDS("tests/testthat/predictions_data_2patches.rds")
} else {
  data <- isolate(reactiveValuesToList(data))
  current_values <- isolate(reactiveValuesToList(current_values))
}
# covarnicenames_tbl <- read.csv("./data/nicecovarnames.csv", header = TRUE)
covarnicenames <- covarnicenames_tbl$NiceName
names(covarnicenames) <- covarnicenames_tbl$TechName
techcovar2nicename <- function(techcovarnames){
  nicenames <- covarnicenames[techcovarnames]
  return(nicenames)
}
```

Welcome to a detailed report of species occupancy estimates for the woody vegetation patches on your farm.
We hope you enjoy it.
In the next section you'll find the information we used to estimate the occupancy probabilities.
Then you'll find short descriptions of the 10 most likely species across your patches, courtesy of BirdLife Australia (TBC).
Later in this report you'll find
the 10 least likely species across your patches, 
a paragraph on the vulnerable Superb Parrot,
and figures showing the occupancy probability of every species in our model.

This report was generated at `r Sys.time()` from version `r packageVersion("sfbiodiversityapp")` of the `r appname`.

# The Patch Properites Used for Estimation
The estimates of bird occupancy in this report are based on the below properties of woody vegetation patches.
The climate information and latitude has been extracted for the region you selected from the \href{https://www.worldclim.org/data/bioclim.html}{WorldClim} (version 1.4) climate database.
The year, midstorey cover, woody vegetation cover within 500m and presence of Noisy Miners were provided by you directly.

\begin{center}
```{r displaypatchprops}
patchprops <- t(newXocc_fromselected(current_values))
makeniceprops <- function(patchprops, ...){
  patchprops[row.names(patchprops) %in% c("MaxTWarmMonth", "MinTColdMonth"), ] <-   # convert temperatures back to celcius
    patchprops[row.names(patchprops) %in% c("MaxTWarmMonth", "MinTColdMonth"), ] / 10
  patchprops[row.names(patchprops) == "NMdetected", ] <- as.logical(patchprops[row.names(patchprops) == "NMdetected", ])
  
  row.names(patchprops) <- techcovar2nicename(row.names(patchprops))
  
  patchprops_char <- format(patchprops, drop0trailing = TRUE, trim = TRUE, ...)
  patchprops_char[row.names(patchprops) == techcovar2nicename("NMdetected"), ] <- 
    as.character(as.logical(as.numeric(patchprops_char[row.names(patchprops) == techcovar2nicename("NMdetected"), ])))
# Precipitation seasonality is a percentage. The R package dismo computes biovars, it imports 'cv' from package Raster (same authors). The code for 'cv' in raster has 100 * sd(z) / mean(z).
  return(patchprops_char)
}
knitr::kable(makeniceprops(patchprops),
      format = "latex",
      booktabs = TRUE,
      row.names = TRUE,
      col.names = paste("Patch", 1:ncol(patchprops)))
```
\end{center}

\emph{Precipitation seasonality} is the ratio of the standard deviation of monthly precipitation over the mean monthly precipitation, expressed as a percentage.

# The 10 Most Likely Species on Your Farm
```{r storyprep}
# the following already loaded inside the app - so its local directory is known
# urls <- get_birdlife_url(row.names(data$species_prob_current))
# stories <- readRDS("data/birdstories.rds")
# imgfilenames <- readRDS("data/imgfilenames.rds")
topten <- order(data$species_prob_current[, "median"], decreasing = TRUE)[1:10]
buildspeclatex_imagestory <- function(specname){
  specinforow <- which(speciesinfo$species == specname)
  out <- c(
    paste0("\\subsection*{", specname, "}"),
    "\\begin{minipage}{0.3\\textwidth}",
    paste0("\\includegraphics[width=1\\linewidth]{", gsub("\\.[^.]*$", "", speciesinfo[specinforow, "imgfilename"]), "}"),
    "\\end{minipage}",
    "\\begin{minipage}{0.7\\textwidth}",
    gsub("http([^[:space:]]*)", "\\\\url{http\\1}", speciesinfo[specinforow, "story"]),
    "\\end{minipage}"
    )
  return(out)
}
```

```{r makelatexincludes_10mostlikely, results='asis'}
for (specname in row.names(data$species_prob_current)[topten]){
  cat(buildspeclatex_imagestory(specname))
}
```

\newpage

# The 10 Least Likely Species on Your Farm
Of the birds in the model, the 10 least likely species to reside in your farm are shown below.
```{r bottomten, results='asis'}
bottomten <- order(data$species_prob_current[, "median"], decreasing = FALSE)[1:10]
buildspeclatex_justimage <- function(specname){
  specinforow <- which(speciesinfo$species == specname)
  credits <- paste0("\\url{", speciesinfo[specinforow, "url"], "}")
  out <- c(
    "\\begin{minipage}[b][0.3\\textwidth][t]{0.25\\textwidth}",
    "\\begin{center}",
    # "\\\\ \\vspace*{1ex} ",
    paste0("\\includegraphics[width=1\\linewidth]{", gsub("\\.[^.]*$", "", speciesinfo[specinforow, "imgfilename"]), "}"),
    specname,
    " \\scriptsize ",
    credits,
    "\\end{center}",
    "\\end{minipage}",
    " "
    )
  return(out)
}
cat(" \\begin{center} ")
for (specname in row.names(data$species_prob_current)[bottomten]){
  cat(buildspeclatex_justimage(specname))
}
cat(" \\end{center} ")
```

\newpage

# A Vulnerable Species: Superb Parrot
The Superb Parrot is listed as vulnerable by the \href{https://www.environment.gov.au/cgi-bin/sprat/public/publicthreatenedlist.pl}{Commonwealth Governement}.
According to our model, there is a `r format(data$species_prob_current["Superb Parrot", "median"] * 100, digits = 2)`% 
(lower bound = `r format(data$species_prob_current["Superb Parrot", "lower"] * 100, digits = 2)`%, upper bound = `r format(data$species_prob_current["Superb Parrot", "upper"] * 100, digits = 2)`%)
chance of the Superb Parrot occupying patch `r data$species_prob_current["Superb Parrot", "bestsite"]`, which was the best patch for the Superb Parrot.

```{r superbparrotinfo, results='asis'}
cat(buildspeclatex_imagestory("Superb Parrot"))
```


```{r consconcern, eval = FALSE}
constatuses %>%
  dplyr::filter(`Fauna Type` == "Birds")
rowintbl <- lapply(model_data$species, function(spec) {
  return(grep(spec, constatuses$`Common Name`))
})
names(rowintbl) <- model_data$species
unlist(rowintbl)
constatuses[unlist(rowintbl), ]
format(data$species_prob_current["Superb Parrot", "median"] * 100, digits = 2)
```

# Occupancy Probability of Every Species in the Model
## Occupancy Probabilty in the Favourite Patch
In general each species has a different favourite patch.
It is the patch with the highest estimated probability of occupancy.
Below shows the probability of each species occupying their most favoured patch.
The favoured patch of each species is given beside the species names.
We are 95% confident that the occupancy probability of this favoured patch is within the error bars shown.

```{r species_on_farm, fig.height = 8, fig.width = 7, out.width = "100%"}
plot_allspeciesprob(data$species_prob_current)
```



\newpage
## Occupancy Probability Relative to the Average Patch
Below shows the ratio of species occupancy probability at their favoured patch to the occupancy probability at the average patch in our data.

```{r relativetomeansite, fig.height = 8, fig.width = 7}
## fun inputs
spec_different <- data$spec_different
##
traits <- get("traits", envir = globalenv())
df_both <- dplyr::left_join(spec_different, traits, by = c(species = "Common Name"))

df_both %>%
  dplyr::rename(`Common Name` = species) %>%
  ordfactby(`Common Name`, `Body Length`) %>%
  ggplot(aes(x = `Common Name`, y = value, fill = value)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip(clip = "off") +
  scale_x_discrete(name = "Increasing Body Length ---->") +
  scale_y_continuous(name = "Ratio", expand = expansion()) +
  ggtitle("Relative Occupancy Probability") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank())
```

\newpage

Note that the average patch in our data had the following attributes
\begin{center}
```{r showavpatch}
knitr::kable(makeniceprops(t(new_data_mean), digits = 3),
      format = "latex",
      booktabs = TRUE,
      row.names = TRUE,
      col.names = "Average Patch")
```
\end{center}









