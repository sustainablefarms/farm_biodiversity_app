---
title: "Species Estimates"
params:
  loadexampledata: TRUE
output: 
  pdf_document: 
    extra_dependencies: booktabs
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
header-includes:
  \renewcommand{\href}[2]{#2\footnote{\url{#1}}}
  \usepackage{tikz}
  \usetikzlibrary{calc}
  \graphicspath{{www/}}  #to get report to build with images change this to ../www/
---

\begin{tikzpicture}[overlay, remember picture]
\node[anchor=north west, %anchor is upper left corner of the graphic
      xshift=2.4cm, %shifting around
      yshift=-2cm] 
     at (current page.north west) %left upper corner of the page
     {\includegraphics[width=3cm]{Sustainable Farms logo RGB.png}}; 
\end{tikzpicture}


```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
if (params$loadexampledata){
  knitr::opts_knit$set(root.dir = normalizePath(".."))
}
```

```{r load, echo = FALSE, include = FALSE}
if (params$loadexampledata){
  pkgload::load_all(".")
  main_app_prep()
  load("reportdata.RData")
} 
predcontext <- predictions_morecontext(cpred$spec_prob, rpred$spec_prob, refisaverage)

# covarnicenames_tbl <- read.csv("./data/nicecovarnames.csv", header = TRUE)
covarnicenames <- covarnicenames_tbl$NiceName
names(covarnicenames) <- covarnicenames_tbl$TechName
techcovar2nicename <- function(techcovarnames){
  nicenames <- covarnicenames[techcovarnames]
  return(nicenames)
}
```

Welcome to a detailed report of species occupancy estimates for the Box Gum Grassy Woodland patches on your farm.
We hope you enjoy it.
In the next section you'll find the information we used to estimate the occupancy probabilities.
Then you'll find pictures of the 10 most likely species across your patches.
Later you'll see 
the 10 least likely species across your patches, 
a paragraph on the vulnerable Superb Parrot,
and the occupancy probability of every species in our model arranged by body length \href{https://www.nature.com/articles/sdata201561}{(Garnett et al. Scientific Data 2, 2015)}.

This report was generated at `r Sys.time()` from version `r appversion` of the Sustainable Farm's `r appname` (`r appurl`).

# The Patch Properites Used for Estimation
The estimates of bird occupancy in this report were based on the below properties of Box Gum Grassy Woodland patches.
The long term climate information was extracted for the region you selected from the \href{https://www.worldclim.org/data/bioclim.html}{WorldClim} (version 1.4) climate database.
We used the centre of your region for this.

The maximum and minimum temperature, summer and winter precipitation, and precipitation seasonality of the prior 12 months had little affect on species occupancy in our fitted model, and were set to the average of our data.
The average temperature of the prior 12 months was set to the long term average to make the app easier to use.
The precipitation in the prior 12 months was supplied by you.

You also provided the 
woody vegetation cover within 500m and 3km, whether the patch is a remnant, and the presence of Noisy Miners.

For ease of use, the year was set to 2018 as year does not have much impact on the species occupancy according to our model (we suspect this is due to other time-varying predictors like woody vegetation canopy and rainfall).

\begin{center}
```{r displaypatchprops}
patchprops <- t(newXocc_fromselected(cval))
makeniceprops <- function(patchprops, ...){
  patchprops[row.names(patchprops) %in% c("MaxTWarmMonth.lt", "MinTColdMonth.lt"), ] <-   # convert temperatures back to celcius
    patchprops[row.names(patchprops) %in% c("MaxTWarmMonth.lt", "MinTColdMonth.lt"), ] / 10
  # patchprops[row.names(patchprops) == "NMdetected", ] <- as.logical(patchprops[row.names(patchprops) == "NMdetected", ])
  # patchprops[row.names(patchprops) == "IsPlanting", ] <- as.logical(patchprops[row.names(patchprops) == "IsPlanting", ])
  patchprops <- patchprops[c(1:5, 9, 6:8, 10:nrow(patchprops)), , drop = FALSE] #make all long-term climate at the top
  
  row.names(patchprops) <- techcovar2nicename(row.names(patchprops))
  
  patchprops_char <- format(patchprops, drop0trailing = TRUE, trim = TRUE, ...)
  patchprops_char[row.names(patchprops) == techcovar2nicename("NMdetected"), ] <- 
    as.character(as.logical(as.numeric(patchprops_char[row.names(patchprops) == techcovar2nicename("NMdetected"), ])))
  patchprops_char[row.names(patchprops) == techcovar2nicename("IsPlanting"), ] <- 
    as.character(as.logical(as.numeric(patchprops_char[row.names(patchprops) == techcovar2nicename("IsPlanting"), ])))

# Precipitation seasonality is a percentage. The R package dismo computes biovars, it imports 'cv' from package Raster (same authors). The code for 'cv' in raster has 100 * sd(z) / mean(z).
  return(patchprops_char)
}
knitr::kable(makeniceprops(patchprops),
      format = "latex",
      booktabs = TRUE,
      row.names = TRUE,
      col.names = paste("Patch", 1:ncol(patchprops)))
```

The region of these patches was: `r cval$selected_region`.
\end{center}


\emph{Precipitation seasonality} is the ratio of the standard deviation of monthly precipitation over the mean monthly precipitation, expressed as a percentage.

# The 10 Most Likely Species on Your Farm
```{r storyprep}
# the following already loaded inside the app - so its local directory is known
# urls <- get_birdlife_url(row.names(data$spec_prob))
# stories <- readRDS("data/birdstories.rds")
# imgfilenames <- readRDS("data/imgfilenames.rds")
topten <- order(cpred$spec_prob[, "median"], decreasing = TRUE)[1:10]
imagetexfun <- function(specinfo){
  imagetex <- paste0("\\includegraphics[width=1\\linewidth, height = 1\\linewidth, keepaspectratio]{",
               gsub("\\.[^.]*$", "", specinfo$imgfilename),
               "}",
               "\\\\ ",
               "\\textcopyright ",
               specinfo$copyrightholder)
}
buildspeclatex_imagestory <- function(specname){
  specinforow <- which(speciesinfo$species == specname)
  imagetex <- imagetexfun(speciesinfo[specinforow,])
  out <- c(
    paste0("\\subsection*{", specname, "}"),
    "\\begin{minipage}{0.3\\textwidth}",
    imagetex,
    "\\end{minipage}",
    "\\hspace{1ex}",
    "\\begin{minipage}{0.7\\textwidth}",
    gsub("http([^[:space:]]*)", "\\\\url{http\\1}", speciesinfo[specinforow, "story"]),
    "\\end{minipage}"
    )
  return(out)
}
```

```{r makelatexincludes_10mostlikely, results='asis'}
for (specname in row.names(cpred$spec_prob)[topten]){
  cat(buildspeclatex_imagestory(specname))
}
```

\newpage

# The 10 Least Likely Species on Your Farm
Of the birds in the model, the 10 least likely species to reside in your Box Gum Grassy Woodland patches are below.
```{r bottomten, results='asis'}
bottomten <- order(cpred$spec_prob[, "median"], decreasing = FALSE)[1:10]
buildspeclatex_justimage <- function(specname){
  specinforow <- which(speciesinfo$species == specname)
  imagetex <- imagetexfun(speciesinfo[specinforow,])
  out <- c(
    "\\begin{minipage}[b][0.40\\textwidth][t]{0.23\\textwidth}",
    "\\begin{center}",
    # "\\\\ \\vspace*{1ex} ",
    specname,
    "\\\\ ",
    "\\scriptsize ",
    imagetex,
    "\\end{center}",
    "\\end{minipage}",
    " "
    )
  return(out)
}
cat(" \\begin{center} ")
for (specname in row.names(cpred$spec_prob)[bottomten]){
  cat(buildspeclatex_justimage(specname))
}
cat(" \\end{center} ")
```

\clearpage
# Vulnerable Species

```{r superbparrotinfo, results='asis'}
texs <- lapply(consstatus$CommonName, function(specname){
  probs <- paste("The", specname, consstatus[specname, "statussummary"],
          onespecwords(specname, cpred$spec_prob,
                       refpredictions = rpred$spec_prob,
                       refisaverage = refisaverage))
  imagewstory <- buildspeclatex_imagestory(specname)
  return(c(imagewstory, probs, "\n"))
})
a <- lapply(texs, cat)
```

\clearpage
# Occupancy Probability of Every Species in the Model
Below is the estimated probability of each species in the model occupying at least one Box Gum Grassy Woodland patch on your farm.
There is a 95% chance that the \emph{true} occupancy probability is within the error bars, assuming our model is correct (the uncertainty is due to uncertainty of model parameter values).

We computed both estimate and error bars by taking the maximum of the occupancy probability of all patches.

```{r species_on_farm, fig.height = 20, fig.width = 7, out.width = "100%"}
all_prob(tocommon(cpred$spec_prob)) %>%
              order_y(.data[["Body Length"]]) %>%
  add_error() %>%
  add_label_onright() 
```

\clearpage
# Occupancy Probability Relative to the Reference
Below shows the ratio of species occupancy probability at their favoured patch to the reference occupancy probability. Beneath is the reference information.

```{r relativetomeansite, fig.height = 20, fig.width = 7}
all_rel(predcontext$spec_different) %>%
  order_y(.data[["Body Length"]])
```

\clearpage
## Reference Attributes and Species Probabilities
\begin{center}
\scriptsize
```{r refregion, results='asis'}
if (refisaverage){
  cat("These reference attributes were the default reference values, which were based on the average of our data. \\\\")
} else {
  refRegion <- rval$selected_region
  cat("The reference patch(es) were in the region:",
      refRegion,
      "\\\\")
}
```
```{r showrefpatch, fig.height = 7, fig.width = 6, out.height = "60%"}
if (refisaverage){
  refpatchprops <- makeniceprops(t(new_data_mean))
} else {
  refpatchprops <- makeniceprops(t(newXocc_fromselected(rval)))
}
knitr::kable(refpatchprops, digits = 3,
      format = "latex",
      booktabs = TRUE,
      row.names = TRUE,
      col.names = paste("Patch", 1:ncol(refpatchprops)))
all_prob(tocommon(rpred$spec_prob)) %>%
              order_y(.data[["Body Length"]]) %>%
  add_error() %>%
  add_label_onright() 
```
\end{center}

\clearpage
# Expected Number of Species

Below presents estimates of the average number of species occupying the `r if (nrow(cval$patchattr_tbl) > 1){"patches"} else {"patch"}` specified `Your Estimate'.
Also shown are estimates of the average number of species if `r if (nrow(cval$patchattr_tbl) > 1){"all patches have"} else {"the patch has"}` woody cover within 500m equal to 2% ('Less woody canopy nearby') or equal to 20% ('More woody canopy nearby').
The estimated average number of species in the reference scenario ('Reference') is also shown.

Due to the species in `r appname`, these estimates should be viewed as an estimate of the average number of sedentary, common, and land-based bird species occupying the `r if (nrow(cval$patchattr_tbl) > 1){"patches"} else {"patch"}`.
According to the statistical model behind these estimates for a single patch, the actual number of species could vary by 8 from the estimated average.

\begin{center}
```{r specrich,  fig.height = 4, fig.width = 8, out.width = "80%"}
richness_plot(cpred$species_richness, labelnudge = -0.25)
```
\end{center}







